generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL") // ★これが必要です
}

// 3. モデル定義（今回投入したテーブル構造に合わせます）
model Prefecture {
  id        Int    @id
  name      String @unique
  name_kana String
  areas     Area[] // リレーション

  @@map("prefectures") // 実際のテーブル名が複数形なら合わせる
}

model City {
  id                    Int                    @id
  prefecture_id         Int
  code                  String                 @unique
  name                  String
  name_kana             String
  areas                 Area[] // リレーション
  distributionSchedules DistributionSchedule[]

  @@map("cities")
}

model Area {
  id                  Int     @id @default(autoincrement())
  prefecture_id       Int
  city_id             Int
  address_code        String  @unique
  town_name           String
  chome_name          String
  boundary_geojson    String? @db.LongText // ｜で繋いだデータは長くなるのでLongText推奨
  door_to_door_count  Int     @default(0)
  multi_family_count  Int     @default(0)
  posting_cap_raw     Int     @default(0)
  posting_cap_with_ng Int     @default(0)
  area_rank_id        Int
  is_client_visible   Int     @default(1)

  // リレーションの定義
  prefecture            Prefecture             @relation(fields: [prefecture_id], references: [id])
  city                  City                   @relation(fields: [city_id], references: [id])
  distributionSchedules DistributionSchedule[]
  orderDistributions OrderDistributionArea[]

  @@map("areas")
}

enum Gender {
  male
  female
  other
  unknown
}

// --- 新規: 社員の階級 (等級) ---
enum EmployeeRank {
  EXECUTIVE   @map("役員")
  DIRECTOR    @map("本部長・事業部長")
  MANAGER     @map("マネージャー")
  LEADER      @map("リーダー")
  ASSOCIATE   @map("アソシエイト(一般)")
}

model Employee {
  id             Int       @id @default(autoincrement())
  passwordHash   String    @map("password_hash") @db.VarChar(255)
  
  lastNameJa     String    @map("last_name_ja") @db.VarChar(50)
  firstNameJa    String    @map("first_name_ja") @db.VarChar(50)
  lastNameEn     String?   @map("last_name_en") @db.VarChar(50)
  firstNameEn    String?   @map("first_name_en") @db.VarChar(50)
  
  email          String    @unique @db.VarChar(100)
  phone          String?   @db.VarChar(20)
  
  // ============================
  // ★ 新規追加: 組織・役職・権限情報
  // ============================
  
  // 1. 支店 (既存のBranchテーブルと紐付け)
  branchId       Int?          @map("branch_id")
  branch         Branch?       @relation("BranchEmployees", fields: [branchId], references: [id])
  
  // 2. 部署
  departmentId   Int?          @map("department_id")
  department     Department?   @relation(fields: [departmentId], references: [id])
  
  // 3. 階級 (Enum)
  rank           EmployeeRank  @default(ASSOCIATE)
  
  // 4. 職種 (テキスト)
  jobTitle       String?       @map("job_title") @db.VarChar(100)
  
  // 5. システム権限
  roleId         Int?          @map("role_id")
  role           Role?         @relation(fields: [roleId], references: [id])

  // ★ 追加: 国マスタとの紐付け
  countryId      Int?          @map("country_id")
  country        Country?      @relation(fields: [countryId], references: [id])

  // ============================

  isActive       Boolean   @default(true) @map("is_active")
  joinedAt       DateTime? @map("joined_at") @db.Date
  leftAt         DateTime? @map("left_at") @db.Date
  
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at")

  // 各種リレーション (既存のものそのまま残す)
  customers          Customer[]
  orders             Order[]
  approvals          OrderApproval[]
  designs            OrderDesign[]
  flyerTransactions  FlyerTransaction[]
  financial          EmployeeFinancial?
  employmentType EmploymentType @default(FULL_TIME) @map("employment_type")

  // ★ 支店のマネージャーとしての逆参照 (エラー解消のキモ)
  managedBranches1   Branch[] @relation("BranchManager1")
  managedBranches2   Branch[] @relation("BranchManager2")
  managedBranches3   Branch[] @relation("BranchManager3")
  managedBranches4   Branch[] @relation("BranchManager4")

  @@map("employees")
}

// --- 雇用形態 ---
enum EmploymentType {
  FULL_TIME   @map("正社員")
  PART_TIME   @map("アルバイト・パート")
  OUTSOURCE   @map("業務委託")
}

// --- 給与形態 ---
enum SalaryType {
  HOURLY      @map("時給")
  DAILY       @map("日給")
  MONTHLY     @map("月給")
}

// --- 社員向け支払方法 ---
enum EmployeePaymentMethod {
  CASH          @map("現金手渡し")
  BANK_TRANSFER @map("銀行振込")
}

// --- 支払サイクル ---
enum PaymentCycle {
  DAILY       @map("日払い")
  WEEKLY      @map("週払い")
  MONTHLY     @map("月払い")
}

// --- 銀行マスタ ---
model Bank {
  id        Int      @id @default(autoincrement())
  code      String   @unique @db.VarChar(20)    // 銀行コード (例: 0001)
  name      String   @db.VarChar(100)           // 銀行名 (例: みずほ銀行)
  nameKana  String?  @map("name_kana") @db.VarChar(100)
  
  financials EmployeeFinancial[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("banks")
}

enum BankAccountType {
  ORDINARY  @map("普通")
  CURRENT   @map("当座")
  SAVINGS   @map("貯蓄")
}

model EmployeeFinancial {
  id                Int              @id @default(autoincrement())
  
  // Employeeとの1対1の紐付け
  employeeId        Int              @unique @map("employee_id")
  employee          Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // --- 給与・契約関連 ---
  salaryType        SalaryType            @default(MONTHLY) @map("salary_type")
  
  baseSalary        Int?                  @map("base_salary")        // 月給
  hourlyRate        Int?                  @map("hourly_rate")        // 時給
  dailyRate         Int?                  @map("daily_rate")         // 日給

  paymentMethod     EmployeePaymentMethod @default(BANK_TRANSFER) @map("payment_method")
  paymentCycle      PaymentCycle          @default(MONTHLY) @map("payment_cycle")
  paymentDay        Int?                  @map("payment_day")        // 月払いの場合の支払日 (例: 25。月末なら99などルール決め)

  transportationFee String?               @map("transportation_fee") // 交通費の規定
  allowance         Int?                  @default(0)                // 役職手当などの固定手当
  
  // --- 控除・保険関連 (給与計算用) ---
  healthInsurance   Int?                  @default(0) @map("health_insurance")       // 健康保険料
  pensionInsurance  Int?                  @default(0) @map("pension_insurance")      // 厚生年金保険料
  employmentInsurance Int?                @default(0) @map("employment_insurance")   // 雇用保険料
  workerAccidentInsurance Int?            @default(0) @map("worker_accident_insurance") // 労災保険料(基本は会社負担ですが一応)
  residentTax       Int?                  @default(0) @map("resident_tax")           // 住民税
  incomeTax         Int?                  @default(0) @map("income_tax")             // 所得税(固定の場合など)

  // --- 銀行口座情報 ---
  // ★ 文字列入力から、Bankマスタへの紐付けに変更
  bankId            Int?                  @map("bank_id")
  bank              Bank?                 @relation(fields: [bankId], references: [id])
  
  branchName        String?               @map("branch_name") @db.VarChar(100)      // 支店名
  branchCode        String?               @map("branch_code") @db.VarChar(20)       // 支店コード
  accountType       BankAccountType?      @map("account_type")                      // 口座種別(普通/当座)
  accountNumber     String?               @map("account_number") @db.VarChar(20)    // 口座番号
  accountName       String?               @map("account_name") @db.VarChar(100)     // 口座名義
  accountNameKana   String?               @map("account_name_kana") @db.VarChar(100)// 口座名義(カナ)

  note              String?               @db.Text                                  // 備考

  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @default(now()) @updatedAt @map("updated_at")

  @@map("employee_financials")
}

model Country {
  id        Int      @id @default(autoincrement())
  code      String   @unique @db.Char(2) // 'JP', 'US' など
  name      String   @db.VarChar(50) // '日本'
  nameEn    String?  @map("name_en") @db.VarChar(50) // 'Japan'
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // リレーション
  employees    Employee[]
  distributors FlyerDistributor[]

  @@map("countries")
}

model Department {
  id        Int      @id @default(autoincrement())
  code      String?  @unique @db.VarChar(20)
  name      String   @db.VarChar(50)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // リレーション
  employees Employee[]

  @@map("departments")
}

model Role {
  id              Int      @id @default(autoincrement())
  name            String   @db.VarChar(50)
  permissionLevel String   @map("permission_level") @db.VarChar(20)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // リレーション
  employees Employee[]

  @@map("roles")
}

// --- 顧客ステータス (Enum) ---
enum CustomerStatus {
  VALID   @map("有効")
  INVALID @map("無効")
}

// ★ 追加: 顧客タイプ (法人 / 個人)
enum CustomerType {
  COMPANY     @map("法人")
  INDIVIDUAL  @map("個人")
}

// --- 顧客マスタ (Customers) ---
model Customer {
  id           Int    @id @default(autoincrement())
  customerCode String @unique @map("customer_code") @db.VarChar(20)
  customerType CustomerType @default(COMPANY) @map("customer_type")

  // 人・組織との紐付け
  salesRepId        Int? @map("sales_rep_id")
  billingCustomerId Int? @map("billing_customer_id")
  parentCustomerId  Int? @map("parent_customer_id")

  // 基本情報
  name     String @db.VarChar(100)
  nameKana String? @map("name_kana") @db.VarChar(100)

  // 請求・インボイス関連
  invoiceRegistrationNumber String? @map("invoice_registration_number") @db.VarChar(14)
  billingCutoffDay          Int?    @map("billing_cutoff_day") @db.TinyInt
  paymentMonthDelay         Int?    @default(1) @map("payment_month_delay") @db.TinyInt
  paymentDay                Int?    @map("payment_day") @db.TinyInt

  // 連絡先
  postalCode      String? @map("postal_code") @db.VarChar(8)
  address         String? @db.VarChar(255) // 住所
  addressBuilding String? @map("address_building") @db.VarChar(255) // 建物名以降 (DDLの2つ目のaddress)
  phone           String? @db.VarChar(20)
  fax             String? @db.VarChar(20)

  // システム制御
  status    CustomerStatus @default(VALID)
  note      String?        @db.Text
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")
  deletedAt DateTime?      @map("deleted_at")

  // --- リレーション定義 ---

  // 1. 担当営業 (Employeeとの紐付け)
  salesRep Employee? @relation(fields: [salesRepId], references: [id])

  // 2. 請求先顧客 (自己参照: 親)
  billingCustomer   Customer?  @relation("BillingRelation", fields: [billingCustomerId], references: [id])
  //    請求先として自身を参照している顧客 (自己参照: 子)
  billedByCustomers Customer[] @relation("BillingRelation")

  // 3. 親顧客 (自己参照: 親)
  parentCustomer Customer?  @relation("ParentRelation", fields: [parentCustomerId], references: [id])
  //    子顧客 (自己参照: 子)
  childCustomers Customer[] @relation("ParentRelation")

  // 4. 担当者マスタ
  contacts CustomerContact[]

  // リレーション（この顧客の配布アイテム明細）
  distributionItems DistributionItem[]

  flyers Flyer[]
  orders   Order[]

  @@map("customers")
}

// --- 顧客担当者マスタ (CustomerContacts) ---
model CustomerContact {
  id         Int @id @default(autoincrement())
  customerId Int @map("customer_id")

  // 担当者個人情報
  lastName      String  @map("last_name") @db.VarChar(50)
  firstName     String  @map("first_name") @db.VarChar(50)
  lastNameKana  String? @map("last_name_kana") @db.VarChar(50)
  firstNameKana String? @map("first_name_kana") @db.VarChar(50)
  department  String? @db.VarChar(50)
  position    String? @db.VarChar(50)
  email       String? @db.VarChar(100)
  mobilePhone String? @map("mobile_phone") @db.VarChar(20)
  directLine  String? @map("direct_line") @db.VarChar(20)

  // 役割フラグ
  isPrimary        Boolean @default(false) @map("is_primary")
  isBillingContact Boolean @default(false) @map("is_billing_contact")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // リレーション
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  orderContacts OrderContact[]
  passwordHash String?   @map("password_hash") @db.VarChar(255) // クライアントログイン用パスワード
  lastLoginAt  DateTime? @map("last_login_at") @db.DateTime(0)

  @@map("customer_contacts")
}

// --- チラシ配布員マスタ (Flyer Distributors) ---
model FlyerDistributor {
  id       Int     @id @default(autoincrement())
  branchId Int?    @map("branch_id")
  branch   Branch? @relation(fields: [branchId], references: [id])
  // ▲ ここまで ▲

  // ★ 追加：国籍のリレーション
  countryId Int?     @map("country_id")
  country   Country? @relation(fields: [countryId], references: [id])

  // 基本情報
  staffId  String    @unique @map("staff_id") @db.VarChar(20) // スタッフID (MBF1001など)
  name     String    @db.VarChar(100) // 名前
  phone    String?   @db.VarChar(20) // 電話番号
  email    String?   @db.VarChar(100) // メールアドレス
  birthday DateTime? @db.Date // 誕生日
  gender   String?   @db.VarChar(10) // 性別 (男性, 女性など)
  address  String?   @db.Text // 住所

  // 在留資格・契約情報
  visaType              String?   @map("visa_type") @db.VarChar(50) // ビザ (ワーホリ, 特定活動など)
  visaExpiryDate        DateTime? @map("visa_expiry_date") @db.Date // 有効期限
  hasAgreedPersonalInfo Boolean   @default(false) @map("has_agreed_personal_info") // 個人情報同意 (○)
  hasSignedContract     Boolean   @default(false) @map("has_signed_contract") // 業務委託締結 (○)
  hasResidenceCard      Boolean   @default(false) @map("has_residence_card") // 在留カード (○)

  // 在籍情報
  joinDate    DateTime? @map("join_date") @db.Date // 入社日
  leaveDate   DateTime? @map("leave_date") @db.Date // 退社日
  leaveReason String?   @map("leave_reason") @db.Text // 退社理由

  // 支払い・口座情報
  paymentMethod       String? @map("payment_method") @db.VarChar(20) // 支払い方法 (現金, 振込など)
  bankName            String? @map("bank_name") @db.VarChar(50) // 銀行
  bankBranchCode      String? @map("bank_branch_code") @db.VarChar(20) // 支店番号
  bankAccountType     String? @map("bank_account_type") @db.VarChar(20) // 口座種類 (普通など)
  bankAccountNumber   String? @map("bank_account_number") @db.VarChar(20) // 口座番号
  bankAccountName     String? @map("bank_account_name") @db.VarChar(100) // 名義
  bankAccountNameKana String? @map("bank_account_name_kana") @db.VarChar(100) // 名義（半角カナ）
  transferNumber      String? @map("transfer_number") @db.VarChar(50) // 振込番号

  // 貸与品・稼働形態
  equipmentBattery     String? @map("equipment_battery") @db.VarChar(50) // バッテリー
  equipmentBag         String? @map("equipment_bag") @db.VarChar(50) // カバン
  equipmentMobile      String? @map("equipment_mobile") @db.VarChar(50) // 携帯
  flyerDeliveryMethod  String? @map("flyer_delivery_method") @db.VarChar(50) // チラシ届け
  transportationMethod String? @map("transportation_method") @db.VarChar(50) // 移動方法 (徒歩など)

  // 給与・評価レート情報
  ratePlan          String? @map("rate_plan") @db.VarChar(50) // Rate (Basic, Regular, Advancedなど)
  rate1Type         Float?  @map("rate_1_type") // 1type
  rate2Type         Float?  @map("rate_2_type") // 2type
  rate3Type         Float?  @map("rate_3_type") // 3type
  rate4Type         Float?  @map("rate_4_type") // 4type
  rate5Type         Float?  @map("rate_5_type") // 5type
  rate6Type         Float?  @map("rate_6_type") // 6type
  transportationFee String? @map("transportation_fee") @db.VarChar(50) // Transporation fee (FULL, 1000など)
  trainingAllowance String? @map("training_allowance") @db.VarChar(50) // 研修手当

  // 目標・実績（KPI）
  rank            String? @db.VarChar(10) // ランク (A, Cなど)
  attendanceCount Int?    @default(0) @map("attendance_count") // 出勤回数
  minTypes        Int?    @map("min_types") // 最低種類
  maxTypes        Int?    @map("max_types") // 最高種類
  minSheets       Int?    @map("min_sheets") // 最低枚数1
  maxSheets       Int?    @map("max_sheets") // 最高枚数1
  targetAmount    String? @map("target_amount") @db.VarChar(50) // 目標金額 (¥8,000–¥9,999など)

  // システム用
  note      String?  @db.Text // 備考
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  schedules DistributionSchedule[]

  @@map("flyer_distributors")
}

// --- 支店マスタ (Branches) ---
model Branch {
  id Int @id @default(autoincrement())

  // 支店名
  nameJa String @map("name_ja") @db.VarChar(100) // 日本語名 (例: 高田馬場)
  nameEn String @map("name_en") @db.VarChar(100) // 英語名 (例: Takadanobaba)

  // 店舗情報
  address      String? @db.Text // 住所
  googleMapUrl String? @map("google_map_url") @db.Text // GoogleMapリンク
  openingTime  String? @map("opening_time") @db.VarChar(10) // 開店時間 (例: "07:00")
  closedDays   String? @map("closed_days") @db.VarChar(50) // 定休日 (例: "火曜日", "土日祝")

  // 店長枠 (1〜4) : Employeeとの紐付け
  manager1Id Int? @map("manager1_id")
  manager2Id Int? @map("manager2_id")
  manager3Id Int? @map("manager3_id")
  manager4Id Int? @map("manager4_id")

  manager1 Employee? @relation("BranchManager1", fields: [manager1Id], references: [id])
  manager2 Employee? @relation("BranchManager2", fields: [manager2Id], references: [id])
  manager3 Employee? @relation("BranchManager3", fields: [manager3Id], references: [id])
  manager4 Employee? @relation("BranchManager4", fields: [manager4Id], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // リレーション（この支店に所属する配布員）
  distributors FlyerDistributor[]
  schedules    DistributionSchedule[]
  employees   Employee[] @relation("BranchEmployees")

  @@map("branches")
}

// ==========================================
// トランザクション (配布予定・実績)
// ==========================================

// --- 1. 配布スケジュール (誰が、どこで、いつ) ---
model DistributionSchedule {
  id          Int            @id @default(autoincrement())
  jobNumber   String?        @map("job_number") @db.VarChar(50) // 仕事番号
  jobCategory String?        @map("job_category") @db.VarChar(50) // 仕事分類
  status      ScheduleStatus @default(UNSTARTED)
  date        DateTime?      @db.Date // 年月日

  // Who (誰が) - 配布員マスタ
  distributorId Int?              @map("distributor_id")
  distributor   FlyerDistributor? @relation(fields: [distributorId], references: [id])

  // 拠点 - 支店マスタ
  branchId Int?    @map("branch_id")
  branch   Branch? @relation(fields: [branchId], references: [id])

  // Where (どこで) - City / Areaマスタと紐付け
  cityId Int?  @map("city_id")
  city   City? @relation(fields: [cityId], references: [id])

  areaId Int?  @map("area_id")
  area   Area? @relation(fields: [areaId], references: [id])

  // 単価・備考
  areaUnitPrice Float?  @map("area_unit_price") // エリア単価
  sizeUnitPrice Float?  @map("size_unit_price") // サイズ単価
  remarks       String? @db.Text // 備考

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // リレーション (What: このスケジュールで配る最大6種類のチラシ)
  items DistributionItem[]

  @@map("distribution_schedules")
}

// --- 2. 配布アイテム明細 (何を、何枚) ---
// --- 2. 配布アイテム明細 (何を、何枚) ---
model DistributionItem {
  id Int @id @default(autoincrement())

  // 親スケジュールとの紐付け
  scheduleId Int                  @map("schedule_id")
  schedule   DistributionSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  // 何番目のチラシか (1〜6)
  slotIndex Int @map("slot_index")

  // What (何を)
  flyerName String? @map("flyer_name") @db.VarChar(200) // チラシ名
  flyerCode String? @map("flyer_code") @db.VarChar(50) // チラシコード

  // 顧客マスタとの紐付け
  customerId Int?      @map("customer_id")
  customer   Customer? @relation(fields: [customerId], references: [id])

  // 受注テーブル(Order)のIDが入る枠
  orderId Int? @map("order_id")

  // 日付フォーマット
  startDate DateTime? @map("start_date") @db.Date // 配布開始日
  endDate   DateTime? @map("end_date") @db.Date // 配布期限
  spareDate DateTime? @map("spare_date") @db.Date // 配布期限予備

  method       String? @db.VarChar(50) // 配布方法 (例: 軒並)
  plannedCount Int?    @map("planned_count") // 予定枚数
  actualCount  Int?    @map("actual_count") // 配布枚数

  // ★ 追加: アイテムごとの備考
  remarks String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // ★ 以下を追加 (Flyerとの紐付け)
  flyerId Int? @map("flyer_id")
  flyer   Flyer? @relation(fields: [flyerId], references: [id])

  @@map("distribution_items")
}

enum ScheduleStatus {
  UNSTARTED // 未開始
  IN_PROGRESS // 配布中
  COMPLETED // 完了
}

// ==========================================
// チラシ・在庫管理モジュール
// ==========================================

// --- 業種マスタ ---
model Industry {
  id        Int      @id @default(autoincrement())
  name      String   @unique @db.VarChar(100)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  flyers    Flyer[]
  @@map("industries")
}

// --- サイズマスタ ---
model FlyerSize {
  id               Int      @id @default(autoincrement())
  name             String   @unique @db.VarChar(20) // 例: A4, B4, A3
  basePriceAddon   Float    @default(0) @map("base_price_addon")
  isFoldRequired   Boolean  @default(false) @map("is_fold_required")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  flyers           Flyer[]
  @@map("flyer_sizes")
}

// --- 折りステータス (Enum) ---
enum FoldStatus {
  NEEDS_FOLDING       // 要折 (自社で折る作業が必要。この状態では配布不可)
  NO_FOLDING_REQUIRED // 折無し (折らずにそのまま配布。配布可能)
  FOLDED              // 折済 (納品時から折られている、または自社で折り作業完了。配布可能)
}

// --- チラシ案件マスタ (Flyer) ---
model Flyer {
  id           Int        @id @default(autoincrement())
  name         String     @db.VarChar(200)
  flyerCode    String?    @unique @map("flyer_code") @db.VarChar(50)
  bundleCount  Int?       @map("bundle_count") // 1束あたりの枚数

  // 関連マスタ
  customerId   Int        @map("customer_id")
  customer     Customer   @relation(fields: [customerId], references: [id])
  industryId   Int        @map("industry_id")
  industry     Industry   @relation(fields: [industryId], references: [id])
  sizeId       Int        @map("size_id")
  size         FlyerSize  @relation(fields: [sizeId], references: [id])

  startDate    DateTime?  @map("start_date") @db.Date
  endDate      DateTime?  @map("end_date") @db.Date

  // ★ いただいた3つのステータスを適用
  foldStatus   FoldStatus @default(NO_FOLDING_REQUIRED) @map("fold_status")

  totalReceived Int       @default(0) @map("total_received") // 累計納品枚数
  stockCount    Int       @default(0) @map("stock_count")    // 現在の有効在庫枚数

  remarks      String?    @db.Text
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  transactions FlyerTransaction[]
  // DistributionItem(スケジュール明細)との紐付けも後ほど追加します
  distributionItems DistributionItem[]
  orderDistributions OrderDistribution[]
  orderPrintings     OrderPrinting[]
  qrCodes QrCode[]

  @@map("flyers")
}

// --- 入出庫種類 (Enum) ---
enum TransactionType {
  RECEIVE   @map("納品(入庫)")
  PICKUP    @map("引取(出庫)")
  TRANSFER  @map("移動")
  DISPOSE   @map("廃棄・調整")
}

// --- 入出庫ステータス (Enum) ---
enum TransactionStatus {
  PENDING   @map("予定")
  COMPLETED @map("完了")
  CANCELED  @map("キャンセル")
}

// --- 入出庫履歴テーブル (FlyerTransaction) ---
model FlyerTransaction {
  id              Int               @id @default(autoincrement())
  flyerId         Int               @map("flyer_id")
  flyer           Flyer             @relation(fields: [flyerId], references: [id], onDelete: Cascade)

  transactionType TransactionType   @map("transaction_type")
  
  expectedAt      DateTime          @map("expected_at") @db.DateTime(0)
  actualAt        DateTime?         @map("actual_at") @db.DateTime(0)
  
  count           Int               // 常に絶対値で入れ、種類に応じてプラスマイナスを計算する

  status          TransactionStatus @default(PENDING)
  isDelayed       Boolean           @default(false) @map("is_delayed") 

  // 担当者 (ドライバーや検品者)
  employeeId      Int?              @map("employee_id")
  employee        Employee?         @relation(fields: [employeeId], references: [id])

  note            String?           @db.Text
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  @@map("flyer_transactions")
}

// ==========================================
// パートナー（外注先）マスタ
// ==========================================
model Partner {
  id            Int         @id @default(autoincrement())
  name          String      @db.VarChar(100) // 外注先企業名
  contactInfo   String?     @map("contact_info") @db.Text

  // ★ 文字列から「パートナータイプマスタ」への紐付けに変更
  partnerTypeId Int         @map("partner_type_id")
  partnerType   PartnerType @relation(fields: [partnerTypeId], references: [id])

  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  printings         OrderPrinting[]
  newspaperInserts  OrderNewspaperInsert[]
  designs           OrderDesign[]

  @@map("partners")
}

// --- パートナータイプマスタ (追加) ---
model PartnerType {
  id        Int       @id @default(autoincrement())
  name      String    @unique @db.VarChar(50) // 例: "印刷会社", "新聞折込" など
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  partners  Partner[]

  @@map("partner_types")
}

// ==========================================
// 受注管理モジュール
// ==========================================

// --- 受注全体ステータス ---
enum OrderStatus {
  DRAFT             @map("一時保存")
  PLANNING          @map("提案中")
  PENDING_PAYMENT   @map("入金待ち")
  PENDING_REVIEW    @map("審査待ち")
  ADJUSTING         @map("調整中")
  CONFIRMED         @map("受注確定")
  IN_PROGRESS       @map("作業中")
  COMPLETED         @map("完了")
  CANCELED          @map("キャンセル")
}

// --- 追加: 承認・審査ステータス ---
enum ApprovalStatus {
  APPROVED    @map("承認済")
  REJECTED    @map("不承認")
}

// --- 審査履歴テーブル ---
model OrderApproval {
  id          Int            @id @default(autoincrement())
  orderId     Int            @map("order_id")
  order       Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  approverId  Int?           @map("approver_id")
  approver    Employee?      @relation(fields: [approverId], references: [id])
  
  status      ApprovalStatus
  comment     String?        @db.Text
  createdAt   DateTime       @default(now()) @map("created_at")

  @@map("order_approvals")
}

// ★ 追加: 受注経路
enum OrderSource {
  WEB_EC
  SALES_INTERNAL
}

// --- 受注ヘッダ (親) ---
model Order {
  id           Int         @id @default(autoincrement())
  orderNo      String      @unique @map("order_no") @db.VarChar(50) 
  
  title        String?     @db.VarChar(200)
  orderSource  OrderSource @default(WEB_EC) @map("order_source")
  paymentMethod String?    @map("payment_method") @db.VarChar(50) 
  
  customerId   Int         @map("customer_id")
  customer     Customer    @relation(fields: [customerId], references: [id])
  
  salesRepId   Int?        @map("sales_rep_id")
  salesRep     Employee?   @relation(fields: [salesRepId], references: [id]) 

  orderDate    DateTime    @map("order_date") @db.Date 
  totalAmount  Int?        @map("total_amount") 
  status       OrderStatus @default(DRAFT)
  remarks      String?     @db.Text

  contacts           OrderContact[] 
  distributions      OrderDistribution[]
  printings          OrderPrinting[]
  newspaperInserts   OrderNewspaperInsert[]
  designs            OrderDesign[]
  payments           Payment[] 
  approvals          OrderApproval[] // ★ 追加: 審査履歴

  @@map("orders")
}

// --- 受注と顧客担当者の中間テーブル (1受注 : N担当者) ---
model OrderContact {
  id                Int             @id @default(autoincrement())
  orderId           Int             @map("order_id")
  order             Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  customerContactId Int             @map("customer_contact_id")
  customerContact   CustomerContact @relation(fields: [customerContactId], references: [id])

  @@map("order_contacts")
}

// --- 1. 配布依頼 ---
model OrderDistribution {
  id           Int       @id @default(autoincrement())
  orderId      Int       @map("order_id")
  order        Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // ★ どのチラシを配るか
  flyerId      Int       @map("flyer_id")
  flyer        Flyer     @relation(fields: [flyerId], references: [id])

  method       String    @db.VarChar(50) // 軒並み, 戸建限定 など
  plannedCount Int       @map("planned_count") // 配布予定枚数

  startDate    DateTime? @map("start_date") @db.Date // 配布開始日
  endDate      DateTime? @map("end_date") @db.Date   // 配布完了期限
  spareDate    DateTime? @map("spare_date") @db.Date // ★ 予備期限 (悪天候時の許容日)

  status       String    @default("UNSTARTED") @db.VarChar(20) // 未手配, 手配済, 配布中, 完了
  remarks      String?   @db.Text

  // ★ 配布エリア (1:N)
  areas        OrderDistributionArea[]

  @@map("order_distributions")
}

// --- 配布依頼とエリアの中間テーブル (1配布依頼 : Nエリア) ---
model OrderDistributionArea {
  id                  Int               @id @default(autoincrement())
  orderDistributionId Int               @map("order_distribution_id")
  orderDistribution   OrderDistribution @relation(fields: [orderDistributionId], references: [id], onDelete: Cascade)
  
  areaId              Int               @map("area_id")
  area                Area              @relation(fields: [areaId], references: [id])

  @@map("order_distribution_areas")
}

// --- 2. 印刷依頼 ---
model OrderPrinting {
  id                   Int       @id @default(autoincrement())
  orderId              Int       @map("order_id")
  order                Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // ★ 印刷するチラシ(すでに登録済みの枠として)
  flyerId              Int?      @map("flyer_id")
  flyer                Flyer?    @relation(fields: [flyerId], references: [id])

  partnerId            Int?      @map("partner_id")
  partner              Partner?  @relation(fields: [partnerId], references: [id]) // 印刷発注先

  printCount           Int       @map("print_count") // 印刷枚数 (配布数+折込数から自動計算等)
  paperSizeId          Int?      @map("paper_size_id")
  // paperSize            FlyerSize? @relation(fields: [paperSizeId], references: [id])
  
  paperType            String?   @map("paper_type") @db.VarChar(50) // コート, マット等
  paperWeight          String?   @map("paper_weight") @db.VarChar(20) // 73kg, 90kg等
  colorType            String?   @map("color_type") @db.VarChar(20) // 両面カラー等
  
  designFileUrl        String?   @map("design_file_url") @db.Text // 原稿データのURL

  orderDate            DateTime? @map("order_date") @db.Date // 印刷発注日
  expectedDeliveryDate DateTime? @map("expected_delivery_date") @db.Date // 納品予定日
  
  status               String    @default("UNORDERED") @db.VarChar(20) // 未発注, 発注済, 納品済

  @@map("order_printings")
}

// --- 3. 新聞折込依頼 ---
model OrderNewspaperInsert {
  id                Int       @id @default(autoincrement())
  orderId           Int       @map("order_id")
  order             Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  partnerId         Int?      @map("partner_id")
  partner           Partner?  @relation(fields: [partnerId], references: [id]) // 折込手配会社

  insertDate        DateTime? @map("insert_date") @db.Date // 折込指定日
  plannedCount      Int       @map("planned_count") // 折込枚数
  newspaperName     String?   @map("newspaper_name") @db.VarChar(50) // 指定紙 (読売, 朝日等)
  areaSpecification String?   @map("area_specification") @db.Text // エリア指定メモ

  status            String    @default("UNORDERED") @db.VarChar(20) // 未手配, 手配済, 完了

  @@map("order_newspaper_inserts")
}

// --- 4. デザイン依頼 ---
model OrderDesign {
  id                 Int       @id @default(autoincrement())
  orderId            Int       @map("order_id")
  order              Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  partnerId          Int?      @map("partner_id")
  partner            Partner?  @relation(fields: [partnerId], references: [id]) // 外注デザイナーの場合
  
  employeeId         Int?      @map("employee_id")
  employee           Employee? @relation(fields: [employeeId], references: [id]) // 社内デザイナーの場合

  designConcept      String?   @map("design_concept") @db.Text
  firstDraftDeadline DateTime? @map("first_draft_deadline") @db.Date
  finalDeadline      DateTime? @map("final_deadline") @db.Date
  
  finalDataUrl       String?   @map("final_data_url") @db.Text // 完成デザインデータURL

  status             String    @default("NOT_STARTED") @db.VarChar(20) // 未着手, 制作中, 校了

  @@map("order_designs")
}

// ==========================================
// ★ 追加: 反響測定（QRコード・トラッキング）モジュール
// ==========================================

model QrCode {
  id          Int      @id @default(autoincrement())
  
  flyerId     Int      @map("flyer_id")
  flyer       Flyer    @relation(fields: [flyerId], references: [id], onDelete: Cascade)

  alias       String   @unique @db.VarChar(100) 
  redirectUrl String   @map("redirect_url") @db.Text 
  memo        String?  @db.VarChar(255)

  isActive    Boolean  @default(true) @map("is_active")

  // ★ 追加: メール通知設定
  notifyOnScan       Boolean  @default(false) @map("notify_on_scan")
  notificationEmails String?  @map("notification_emails") @db.Text // カンマ区切りで複数保存

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  scanLogs    QrScanLog[]

  @@map("qr_codes")
}

model QrScanLog {
  id          Int      @id @default(autoincrement())
  
  qrCodeId    Int      @map("qr_code_id")
  qrCode      QrCode   @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)

  scannedAt   DateTime @default(now()) @map("scanned_at") 

  ipAddress   String?  @map("ip_address") @db.VarChar(50)
  userAgent   String?  @map("user_agent") @db.Text
  deviceType  String?  @map("device_type") @db.VarChar(50)
  os          String?  @db.VarChar(50)
  browser     String?  @db.VarChar(50)
  location    String?  @db.VarChar(100) 
  
  // ★ 追加: ユニークユーザー識別用ID (Cookieの値を保存)
  visitorId   String?  @map("visitor_id") @db.VarChar(100)

  @@map("qr_scan_logs")
}

// --- 決済方法 ---
enum PaymentMethod {
  CREDIT_CARD     @map("クレジットカード")
  INVOICE         @map("請求書払い")
  BANK_TRANSFER   @map("銀行振込")
}

// --- 決済ステータス ---
enum PaymentStatus {
  PENDING     @map("未決済")
  AUTHORIZED  @map("与信枠確保")
  COMPLETED   @map("入金済")
  FAILED      @map("決済失敗")
  REFUNDED    @map("返金済")
}

// --- 決済履歴テーブル ---
model Payment {
  id              Int           @id @default(autoincrement())
  
  orderId         Int           @map("order_id")
  order           Order         @relation(fields: [orderId], references: [id])
  
  amount          Int           
  method          PaymentMethod 
  status          PaymentStatus @default(PENDING) 
  
  transactionId   String?       @map("transaction_id") @db.VarChar(100) 
  paidAt          DateTime?     @map("paid_at") @db.DateTime(0) 
  
  note            String?       @db.Text 
  
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  @@map("payments")
}